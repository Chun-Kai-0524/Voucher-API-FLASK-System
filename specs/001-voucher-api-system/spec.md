# Feature Specification: Voucher Management API System

**Feature Branch**: `001-voucher-api-system`  
**Created**: 2025-11-14  
**Status**: Draft  
**Input**: 優惠券管理系統 API - 使用 API-FLASK + SQLAlchemy 2.0，包含 CRUD、查詢篩選、批次操作、pytest 測試

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 基本優惠券 CRUD 操作 (Priority: P1)

作為 API 使用者，我需要能夠創建、查詢、修改和刪除優惠券，以便管理系統中的優惠券資料。

**Why this priority**: 這是系統的核心功能，沒有這些基本操作，系統無法運作。這是 MVP 的基礎。

**Independent Test**: 可以通過 API 測試工具獨立測試每個 endpoint，無需依賴其他功能。每個操作都可以獨立驗證其正確性。

**Acceptance Scenarios**:

1. **Given** 系統已啟動，**When** 我發送創建優惠券的請求（包含名稱、價格、折扣、有效期），**Then** 系統返回成功狀態和優惠券詳細資訊（包含自動生成的唯一編號）
2. **Given** 系統中存在多個優惠券，**When** 我請求查詢優惠券列表，**Then** 系統返回所有優惠券的列表
3. **Given** 系統中存在一個優惠券，**When** 我發送修改優惠券名稱的請求，**Then** 系統返回成功狀態和更新後的優惠券資訊
4. **Given** 系統中存在一個未使用的優惠券，**When** 我發送刪除該優惠券的請求，**Then** 系統確認刪除成功且該優惠券已被移除
5. **Given** 我發送請求時缺少必要欄位，**When** 系統接收到請求，**Then** 系統返回錯誤狀態和明確的錯誤訊息

---

### User Story 2 - 優惠券查詢與篩選 (Priority: P1)

作為 API 使用者，我需要能夠使用多種條件篩選優惠券，以便快速找到符合特定需求的優惠券。

**Why this priority**: 查詢功能是使用頻率最高的操作，且是後續批次操作的基礎。必須與基本 CRUD 同步開發。

**Independent Test**: 可以獨立測試各種查詢參數組合，驗證篩選邏輯的正確性。

**Acceptance Scenarios**:

1. **Given** 系統中存在多個優惠券，**When** 我使用狀態條件查詢，**Then** 系統只返回符合該狀態的優惠券
2. **Given** 系統中存在多個優惠券，**When** 我使用折扣範圍條件查詢，**Then** 系統返回折扣百分比在指定範圍內的優惠券
3. **Given** 系統中存在已過期和未過期的優惠券，**When** 我使用可用性條件查詢，**Then** 系統只返回可用且未過期的優惠券
4. **Given** 系統中存在大量優惠券，**When** 我使用分頁參數查詢，**Then** 系統返回指定頁數的資料

---

### User Story 3 - 優惠券狀態管理 (Priority: P2)

作為系統管理員，我需要優惠券狀態能夠自動更新（過期、已使用），以確保資料的準確性。

**Why this priority**: 狀態管理確保業務邏輯的正確性，但可以在基本 CRUD 之後實作。

**Independent Test**: 可以通過時間模擬和狀態變更測試獨立驗證。

**Acceptance Scenarios**:

1. **Given** 一個優惠券的有效期已過，**When** 系統查詢該優惠券時，**Then** 系統自動將狀態更新為「過期」
2. **Given** 一個優惠券狀態為「已使用」，**When** 我嘗試刪除該優惠券，**Then** 系統拒絕刪除並返回錯誤訊息
3. **Given** 一個優惠券狀態為「未使用」，**When** 我發送請求將狀態更新為「已使用」，**Then** 系統成功更新狀態且記錄使用時間

---

### User Story 4 - 批次優惠券操作 (Priority: P3 - 加分項)

作為系統管理員，我需要能夠批次創建或修改大量優惠券（百萬級別），以提升操作效率。

**Why this priority**: 這是效能優化和加分項，不影響基本功能運作。可以在核心功能穩定後實作。

**Independent Test**: 可以通過性能測試工具獨立測試批次操作的效能和正確性。

**Acceptance Scenarios**:

1. **Given** 我準備了一個包含 10,000 筆優惠券資料的資料集，**When** 我發送批次創建請求，**Then** 系統在合理時間內完成所有創建，並返回成功和失敗的統計資訊
2. **Given** 系統中存在 100,000 筆優惠券，**When** 我發送批次修改請求，**Then** 系統正確處理並發競爭，確保資料一致性
3. **Given** 批次操作過程中部分資料驗證失敗，**When** 系統處理這些請求，**Then** 系統返回詳細的錯誤報告，標明哪些資料成功、哪些失敗及原因

---

### Edge Cases

- **過期判斷**: 當優惠券有效期為今天 23:59:59 時，如何判斷是否過期？使用 UTC 時間，過期判斷包含當日
- **並發修改**: 當兩個請求同時修改同一個優惠券時，如何處理？使用資料庫事務確保一致性
- **刪除檢核**: 已使用的優惠券不可刪除，過期的優惠券可以刪除
- **折扣百分比範圍**: 折扣百分比限制在 0-100 之間，負數和超過 100 的值將被拒絕
- **批次操作失敗處理**: 批次創建時如果部分失敗，採用部分成功模式，成功的記錄保留，失敗的記錄返回錯誤詳情
- **大量資料查詢**: 當資料庫有百萬筆優惠券時，使用分頁和資料庫索引優化查詢效能

## Requirements *(mandatory)*

### Functional Requirements

#### API 設計
- **FR-001**: 系統必須提供 RESTful API，使用正確的 HTTP methods（POST/GET/PATCH/DELETE）
- **FR-002**: 所有 API 必須包含輸入資料驗證，返回明確的驗證錯誤訊息
- **FR-003**: API 必須返回標準的狀態碼（200, 201, 400, 404, 500）
- **FR-004**: API 必須自動生成文檔，可通過瀏覽器訪問

#### 優惠券創建
- **FR-101**: 系統必須提供創建優惠券的功能
- **FR-102**: 創建時必須驗證必填欄位：優惠券名稱、價格、折扣百分比、有效期
- **FR-103**: 系統必須自動生成唯一編號（整數自增或 UUID）
- **FR-104**: 新創建的優惠券預設狀態為「未使用」，預設可用狀態為 true

#### 優惠券查詢
- **FR-201**: 系統必須提供查詢優惠券列表的功能
- **FR-202**: 系統必須提供查詢單一優惠券的功能
- **FR-203**: 列表查詢必須支援分頁（page, per_page 參數）
- **FR-204**: 列表查詢必須支援以下欄位篩選：
  - 優惠券名稱（模糊搜尋）
  - 價格範圍（min_price, max_price）
  - 折扣百分比範圍（min_discount, max_discount）
  - 狀態（status: unused/used/expired）
  - 是否可用（is_available）
  - 有效期範圍（valid_from, valid_to）

#### 優惠券修改
- **FR-301**: 系統必須提供修改優惠券的功能，支援部分更新（PATCH）
- **FR-302**: 可修改欄位包含：優惠券名稱、價格、折扣百分比、有效期、是否可用、狀態
- **FR-303**: 修改操作必須驗證資料格式和業務規則
- **FR-304**: 系統必須自動記錄修改時間

#### 優惠券刪除
- **FR-401**: 系統必須提供刪除優惠券的功能
- **FR-402**: 刪除前必須檢查：已使用的優惠券不可刪除
- **FR-403**: 刪除不存在的優惠券應返回 404 錯誤

#### 資料驗證
- **FR-501**: 價格必須為正數，支援小數點後兩位
- **FR-502**: 折扣百分比必須在 0-100 之間（整數或小數）
- **FR-503**: 有效期格式必須為 ISO 8601 日期時間格式
- **FR-504**: 優惠券名稱不可為空，長度限制 1-100 字元

#### 效能要求（加分項）
- **FR-601**: 系統必須提供批次創建功能
- **FR-602**: 系統必須提供批次修改功能
- **FR-603**: 批次操作必須使用並行處理（asyncio）提升效能
- **FR-604**: 批次操作必須處理並發競爭問題（race condition）
- **FR-605**: 批次操作必須返回詳細的執行結果（成功數、失敗數、錯誤列表）

### Key Entities

#### Voucher (優惠券)
優惠券是系統的核心實體，代表可用於折扣的券碼。包含以下關鍵資訊：

- **唯一編號**: 系統自動生成的主鍵識別碼，確保每張優惠券可被唯一識別
- **優惠券名稱**: 描述性文字，幫助識別優惠券用途，長度 1-100 字元
- **價格**: 優惠券的面額或原價，使用貨幣金額表示，正數，精確到小數點後 2 位
- **折扣百分比**: 優惠折扣力度，0-100 之間的數值，0 表示無折扣，100 表示全免
- **有效期**: 優惠券的到期日期時間，過期後不可使用
- **是否可用**: 標記優惠券是否可以被使用，可手動設定為不可用
- **狀態**: 優惠券的使用狀態，包含三種：
  - 未使用（unused）：創建後的初始狀態
  - 已使用（used）：已被消費使用
  - 過期（expired）：超過有效期
- **創建時間**: 優惠券創建的時間戳記，系統自動記錄
- **修改時間**: 最後一次修改的時間戳記，系統自動更新
- **使用時間**: 當狀態變為「已使用」時記錄的時間戳記，初始為空

**業務規則**:
- 當有效期小於當前時間，狀態自動判定為「過期」
- 已使用的優惠券不可再次使用，不可被刪除
- 過期的優惠券可用性自動為 false
- 同一時間只能有一個狀態（互斥）

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 所有 API 操作的輸入驗證正確率達到 99%以上，錯誤訊息清晰明確
- **SC-002**: 單筆優惠券查詢回應時間少於 100 毫秒（在 10,000 筆資料情況下）
- **SC-003**: 批次創建 10,000 筆優惠券的處理時間少於 30 秒
- **SC-004**: 所有核心功能（CRUD + 查詢篩選）的單元測試覆蓋率超過 80%
- **SC-005**: API 文檔自動生成且完整，涵蓋所有端點、參數、回應範例
- **SC-006**: 系統能夠成功通過 Docker 啟動，或提供可執行的資料庫初始化 SQL 腳本
- **SC-007**: Git 提交歷史清晰，每個 commit 都是獨立的功能單元，commit message 遵循規範
- **SC-008**: README 文檔完整，包含環境設定、依賴安裝、啟動步驟、API 使用範例

### Technical Validation

- **TV-001**: 使用 API-FLASK 框架，遵循官方建議的最佳實踐
- **TV-002**: ORM 使用 SQLAlchemy 2.0 語法（使用 Mapped 類型提示）
- **TV-003**: 程式碼中至少有一處使用 *args 或 **kwargs 的範例
- **TV-004**: 專案架構分層清晰：API 層、Service 層、Repository 層、Model 層
- **TV-005**: 程式碼風格符合 PEP 8 規範，變數命名清晰易懂
- **TV-006**: 所有 pytest 測試通過，無失敗案例，測試案例涵蓋正常和異常情況

### Business Validation

- **BV-001**: 刪除操作包含業務檢核（已使用的優惠券拒絕刪除）
- **BV-002**: 優惠券狀態變更邏輯正確（未使用→已使用，自動過期判斷）
- **BV-003**: 過期優惠券無法被標記為「已使用」（業務規則檢核）
- **BV-004**: 批次操作的錯誤處理完善，部分失敗不會導致已成功的資料回滾
